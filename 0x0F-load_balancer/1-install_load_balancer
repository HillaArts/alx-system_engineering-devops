#!/usr/bin/env bash

# Replace STUDENT_ID with your actual student ID
STUDENT_ID="your_student_id_here"
WEB_01="${STUDENT_ID}-web-01"
WEB_02="${STUDENT_ID}-web-02"

# Step 1: Update the system and install HAproxy
sudo apt-get update
sudo apt-get install -y haproxy

# Step 2: Configure HAproxy
# Backup the original HAproxy config file
sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak

# Write the new configuration to haproxy.cfg
cat <<EOT | sudo tee /etc/haproxy/haproxy.cfg
global
    log /dev/log local0
    log /dev/log local1 notice
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

frontend http_front
   bind *:80
   stats uri /haproxy?stats
   default_backend http_back

backend http_back
   balance roundrobin
   server 245394-web-01 54.157.133.197:80 check
   server 245394-web-02 54.87.237.85:80 check
EOT

# Step 3: Enable HAProxy to be managed via an init script
# This step may vary depending on the system; for most modern systems, HAProxy
# can be enabled and managed using systemctl by default. The ENABLED=1 line is
# more relevant for older systems but including for compatibility.
echo "ENABLED=1" | sudo tee /etc/default/haproxy

# Enable and start HAProxy service (systemd)
sudo systemctl enable haproxy
sudo systemctl start haproxy

# Optional: Check HAProxy status
sudo systemctl status haproxy

# Verify the configuration is correct
sudo haproxy -c -f /etc/haproxy/haproxy.cfg

echo "HAProxy has been configured and started."
